#!/bin/sh

# Set up test directory
src=`pwd`
tmp=/tmp/rts-tmp
rm -rf $tmp
mkdir $tmp
cvm=$tmp/cvm
uid=`id -u`
gid=`id -g`

# Support functions
rem() { echo; echo --- "$@"; }

rem Testing command module with prefix
$src/cvm-testclient cvm-command:$src/cvm-unix cvmtest '' cvmpass

rem Testing command module no prefix
$src/cvm-testclient $src/cvm-unix cvmtest '' cvmpass

rem Testing command module bad password
$src/cvm-testclient $src/cvm-unix cvmtest '' cvmpassx

rem Testing command module bad username
$src/cvm-testclient $src/cvm-unix cvmtestx '' cvmpass

rem Testing command module different case username
$src/cvm-testclient $src/cvm-unix cvmtest '' cvmpass

rem Starting up local server
$src/cvm-unix-local $tmp/socket &
pid=$!
sleep 1

rem Testing local module
$src/cvm-testclient cvm-local:$tmp/socket cvmtest '' cvmpass

rem Testing local module, bad password
$src/cvm-testclient cvm-local:$tmp/socket cvmtest '' cvmpassx

rem Stopping local server
kill $pid
sleep 1

rem Does local server remove its socket on exit?
ls -1 $tmp/socket

rem Starting up UDP server
$src/cvm-unix-udp 127.1.2.3 12345 &
pid=$!
sleep 1

rem Testing UDP module
$src/cvm-testclient cvm-udp:127.1.2.3:12345 cvmtest '' cvmpass

rem Testing UDP module, bad password
$src/cvm-testclient cvm-udp:127.1.2.3:12345 cvmtest '' cvmpassx

rem Stopping UDP server
kill $pid
sleep 1

rem Testing various SQL query substitutions
sqt() { env - var1=1 var_2=2 $src/sql-query-test "$@"; }
sqt 'one two' act dom
sqt '$account $domain one two' act dom
sqt 'one $account two' act dom
sqt 'one two $account' act dom
sqt '$var1 one two' act dom
sqt 'one $var1 two' act dom
sqt 'one two $var1' act dom
sqt '$var_2 one two' act dom
sqt 'one $var_2 two' act dom
sqt 'one two $var_2' act dom
sqt '$var1one two' act dom
sqt 'one $var1two' act dom
sqt '${var1} one two' act dom
sqt 'one ${var1} two' act dom
sqt 'one two ${var1}' act dom

# Cleanup
rm -rf $tmp
